<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
	    <!--
    <template id="custom_header" inherit_id="l10n_cl.custom_header">
        <xpath expr="//span[@name='company_activity']" position="after">
	    <div style="font-size:16px;line-height:16px;margin-bottom:3px;margin-top:3px">
                <span t-field="o.company_id.l10n_cl_info_sucursales" widget="html"/>
            </div>
        </xpath>
    </template>
	    -->

        <!-- QWeb Reports -->
        <record id="report_invoice_action" model="ir.actions.report">
            <field name="name">Documento Electrónico</field>
            <field name="model">account.move</field>
            <field name="report_type">qweb-pdf</field>
            <field name="report_name">formato_l10n_cl.report_invoice</field>
            <field name="report_file">formato_l10n_cl.report_invoice</field>
            <field name="binding_model_id" ref="account.model_account_move"/>
            <field name="binding_type">report</field>
        </record>


        <template id="report_invoice">
        <t t-foreach="docs" t-as="o">
            <t t-set="lang" t-value="o.partner_id.lang"/>
            <t t-set="l10n_cl_doc" t-value="o.l10n_latam_document_type_id.code"/>

	    <!-- Primera pagina -->
            <t t-call="formato_l10n_cl.report_invoice_detail" t-lang="lang">
	        <div t-attf-class="footer o_background_footer"/>
	    </t>

	    <!-- Segunda pagina (cedible) -->
            <t t-if="l10n_cl_doc == '33'" t-call="formato_l10n_cl.report_invoice_detail" t-lang="lang">
	    <div t-attf-class="footer o_background_footer">
	        <div style="font-size:12px;border:1px solid black;width=100%;padding:5px;">
		    <table>
	                <tr style="width:100%">
	                    <td style="width:5%;">Nombre: </td><td style="width:20%;border-bottom: 1px solid black;"></td>
	                    <td style="width:5%;">RUT: </td><td style="width:10%;border-bottom: 1px solid black;"></td>
	                    <td style="width:5%;">Fecha: </td><td style="width:10%;border-bottom: 1px solid black;"></td>
	                    <td style="width:5%;">Recinto: </td><td style="width:15%;border-bottom: 1px solid black;"></td>
	                    <td style="width:5%;">Firma: </td><td style="width:15%;border-bottom: 1px solid black;"></td>
		        </tr>
			<tr>
			    <td colspan="10"><i>"El acuse de recibo que se declara en este acto, de acuerdo a lo dispuesto en la letra b) del Art. 4°, y la letra c) del Art. 5° de la Ley 19.983, acredita que la entrega de mercaderías o servicio(s) prestado(s) ha(n) sido recibido(s)"</i></td>
			</tr>
		    </table>

	        </div>
		<div style="width:100%;color:red;text-align:right;font-weight:bold;font-size:large;padding-top:5px;padding-bottom:45px;">CEDIBLE</div>
            </div>

	    </t>

        </t>
        </template>

        <template id="document_tax_totals">
        <!--
                ARGUMENTS:
                - tax_totals: dict in the form generated by account.move's _get_tax_totals.
        -->
            <t t-foreach="tax_totals['subtotals']" t-as="subtotal">
                <tr>
                    <td>MONTO NETO</td>
                    <td class="text-right">
                        <span t-att-class="oe_subtotal_footer_separator" t-esc="subtotal['formatted_amount']"/>
                    </td>
                </tr>

                <t t-set="subtotal_to_show" t-value="subtotal['name']"/>
                <t t-call="account.tax_groups_totals"/>
            </t>

            <!--Total amount with all taxes-->
            <tr>
                <td>MONTO TOTAL</td>
                <td class="text-right">
                    <span t-esc="tax_totals['formatted_amount_total']"/>
                </td>
            </tr>
        </template>


        <template id="report_invoice_detail">
	    <t t-call="web.basic_layout" t-lang="lang">

		<div class="header" style="font-size: 13px;">
                    <t t-set="report_date"        t-value="o.invoice_date"/>
                    <t t-set="report_number"      t-value="int(o.l10n_latam_document_number)"/>
                    <t t-set="pre_printed_report" t-value="report_type == 'pdf'"/>
                    <t t-set="report_name"        t-value="o.l10n_latam_document_type_id.name"/>
                    <t t-set="header_address"     t-value="o.company_id.partner_id"/>
                    <t t-set="sale_orders"        t-value="o._get_sale_orders()"/>
                    <t t-set="sale_sellers"       t-value="o._get_sellers()"/>

		    <!-- Evita el wrap -->
		    <div class="row">
                    <div name="left-upper-side" class="col-8">
		        <div class="row" style="padding-left: 0px;">
                            <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)" style="max-height: 65px;" alt="Logo"/>
	                </div>
                        <strong><span t-field="o.company_id.partner_id.name"/></strong>
                        <br/>
                        <span name="company_activity" t-field="o.company_id.l10n_cl_activity_description"/>
                        <br/>
	                <t t-esc="' - '.join([item for item in [
                        ', '.join([item for item in [header_address.street, header_address.street2] if item]),
                        header_address.city,
                        header_address.state_id and header_address.state_id.name,
                        header_address.zip,
                        header_address.country_id and header_address.country_id.name] if item])"/>
                        <span t-if="header_address.phone">
                            <br/>
                        </span>
                        <span t-if="header_address.phone" style="white-space: nowrap;"
                          t-esc="'Tel: ' + header_address.phone"/>
                        <!--
			<t t-if="o.company_id.l10n_cl_info_sucursales">
                            <br/>
	                    <div style="font-size:12px;">
		                <span t-if="o.company_id.l10n_cl_info_sucursales" name="l10n_cl_info_sucursales" t-field="o.company_id.l10n_cl_info_sucursales"/>
		            </div>
		        </t>
			-->
                        <span t-if="header_address.website">
				<span>- </span><span t-esc="' - '.join([item for item in [header_address.email,header_address.website.replace('https://', '').replace('http://', '')] if item])"/>
                        </span>
	            </div>
		    <!--
		    <div class="col-2">
	            </div>
                        <div class="row border border-dark">
                                <h6 t-att-style="'color: %s;' % o.company_id.primary_color">
                                <strong t-att-style="'color: %s;' % o.company_id.primary_color">
		    -->
	    	    <div class="col-4">
                        <div class="row" style="color:red;border: 2px solid red">
                            <div class="col-12 text-center">
                                <h6>
                                <strong>
                                <br/>
                                <span style="line-height: 180%;">RUT:</span>
                                <span t-esc="o.company_id.partner_id._format_dotted_vat_cl(o.company_id.partner_id.vat)"/>
                                <br/>
                                <span class="text-uppercase" t-esc="report_name"/>
                                <br/>
                                <span>Nº:</span>
                                <span style="line-height: 200%;" t-esc="report_number"/>
                                <br/>
                                <br/>
                                </strong>
                                </h6>
                            </div>
                        </div>
                        <div class="row text-center" style="color:red">
                            <div class="col-12 text-center" name="regional_office" style="text-transform: uppercase;">
			        <strong>S.I.I. - <span t-field="o.company_id.l10n_cl_sii_regional_office"/></strong>
			    </div>
                        </div>
                    </div>
	            </div> <!-- Evita el wrap -->
		</div>

                <!-- Logo 
		<div class="page" style="padding-left: 150px;padding-top: 35px;padding-bottom: 15px;">
                    <img t-if="o.company_id.logo" t-att-src="image_data_uri(o.company_id.logo)" style="max-height: 50px;" alt="Logo"/>
	        </div>
			-->


                <t t-set="direccion_cliente" t-value="', '.join([item for item in [o.partner_id.street, o.partner_id.street2] if item])"/>
                <t t-set="giro_cliente" t-value="o.partner_id.l10n_cl_activity_description"/>
		<t t-set="nombre_cliente" t-value="o.partner_id.name"/>
                <div class="page" style="font-size:12px;width:100%;">
		    <table style="width:100%;border:1px solid black">
                        <tr style="background-color:#c0c0c0;">
				<td class="text-center" style="border:1px solid black;width:50%;"><b><span>DATOS CLIENTE</span></b></td>
				<td class="text-center" style="border:1px solid black;width:50%;"><b><span>CONDICIONES DE VENTA</span></b></td>
		        </tr>
                        <tr>
			    <td class="text-left" name="td_reference_origin" style="border:1px solid black;padding-left:5px;">
				<table style="width:100%;">
				    <tr><td style="width:25%;">SEÑOR(ES)</td><td>: <span t-esc="nombre_cliente[:44] if nombre_cliente else ''"/></td></tr>
				    <tr><td>R.U.T.</td><td>: <span t-field="o.partner_id.vat"/></td></tr>
				    <tr><td>DIRECCION</td><td>: <span t-esc="direccion_cliente[:44] if direccion_cliente else ''"/></td></tr>
				    <tr><td>COMUNA</td><td>: <span t-esc="o.partner_id.city"/></td></tr>
				    <tr><td>CIUDAD</td><td>: <span t-esc="o.partner_id.city"/></td></tr>
				    <tr><td>GIRO</td><td>: <span t-esc="giro_cliente[:44] if giro_cliente else ''"/></td></tr>
				</table>
			    </td>
			    <td class="text-left" name="td_reference_doc_type" style="border:1px solid black;padding-left:5px;">
				<table style="width:100%;">
				    <tr><td style="width:40%;">E-MAIL</td><td>: <span t-field="o.partner_id.email"/></td></tr>
				    <tr><td>FECHA EMISION</td><td>: <span t-esc="o.invoice_date" t-options='{"widget": "date"}'/></td></tr>
				    <tr><td>CONDICION DE PAGO</td><td>: <span t-esc="o.invoice_payment_term_id.name or ''"/></td></tr>
				    <tr><td>TIPO DE PEDIDO</td><td>: </td></tr>
				    <tr><td>VENDEDOR</td><td>: <span t-esc="sale_sellers or ''"/></td></tr>
				    <tr><td>ORDEN DE COMPRA</td><td>: <span t-esc="sale_orders or ''"/></td></tr>
				</table>
			    </td>
		        </tr>
		    </table>
                </div>

		<!-- Cuerpo -->
                <div class="page" style="font-size:14px;width:100%;padding-left:0px;padding-right:0px">
		    <table style="width:100%;border:1px solid black;margin-top:5px;">
                        <tr style="background-color:#c0c0c0;">
				<td class="text-center" style="vertical-align: middle;width:10%;border-right:1px solid black"><b><span>CODIGO</span></b></td>
				<td class="text-center" style="vertical-align: middle;width:60%;border-right:1px solid black"><b><span>DESCRIPCION</span></b></td>
				<td class="text-center" style="vertical-align: middle;width:10%;border-right:1px solid black"><b><span>CANTIDAD</span></b></td>
				<td class="text-center" style="vertical-align: middle;width:10%;border-right:1px solid black"><b><span>VALOR UNITARIO</span></b></td>
					<!--<td class="text-center" style="vertical-align: middle;width:5%;border-right:1px solid black"><b><span>SUB TOTAL</span></b></td>-->
		        </tr>
			<t t-set="max_lines" t-value="0"/>
			<t t-set="current_subtotal" t-value="0"/>
                        <t t-set="lines" t-value="o.invoice_line_ids.sorted(key=lambda l: (-l.sequence, l.date, l.move_name, -l.id), reverse=True)"/>
			<t t-foreach="lines" t-as="line">
			    <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                            <t t-set="current_subtotal" t-value="current_subtotal + line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
			    <t t-if="not line.display_type">
                            <tr>
			    <td class="text-right" style="border-right:1px solid black;padding-left:2px;padding-right:2px;"><span t-field="line.product_id.default_code" t-options="{'widget': 'text'}"/></td>
			    <td class="text-left" style="border-right:1px solid black;padding-left:2px;padding-right:2px;"><span t-field="line.name" t-options="{'widget': 'text'}"/></td>
			    <td class="text-right text-nowrap" style="border-right:1px solid black;padding-left:2px;padding-right:2px;">
			        <span t-field="line.quantity"/>
                                <span t-field="line.product_uom_id.name" groups="uom.group_uom"/>
                            </td>
    			    <td class="text-right" style="border-right:1px solid black;padding-left:2px;padding-right:2px;"><span class="text-nowrap" t-field="line.price_unit"/></td>
			    <!--
			    <td class="text-right o_price_total" style="padding-left:2px;padding-right:2px;">
                                <span class="text-nowrap" t-field="line.price_subtotal" groups="account.group_show_line_subtotals_tax_excluded"/>
                                <span class="text-nowrap" t-field="line.price_total" groups="account.group_show_line_subtotals_tax_included"/>
                            </td>
			    -->
			    </tr>

		            </t>
			    <t t-set="max_lines" t-value="max_lines + 1"/>
		        </t>

			<t t-foreach="range(15 - max_lines - 1)" t-as="l">
			    <tr>	
				<td style="color:#FFFFFF;line-height:1.7em;border-right:1px solid black;">.</td>
				<td style="color:#FFFFFF;line-height:1.7em;border-right:1px solid black;">.</td>
				<td style="color:#FFFFFF;line-height:1.7em;border-right:1px solid black;">.</td>
				<td style="color:#FFFFFF;line-height:1.7em;border-right:1px solid black;">.</td>
			    </tr>	
                        </t>

		    </table>
                </div> <!-- Cuerpo -->

		<!-- Monto en texto -->
                <t t-set="num_text" t-value="o._l10n_cl_edi_amount_to_text()"/>
                <div class="page text-nowrap" style="font-size:12px;width:100%;text-align:left;margin-top:5px;">
		        <strong>Son: <span t-esc="num_text + ' ' + o.currency_id.currency_unit_label"/></strong>
                </div>

		<!-- Footer -->
		<!--Tax totals-->
                <t t-set="tax_totals" t-value="json.loads(o.tax_totals_json)"/>

		<div class="row page" style="font-size:12px;width:100%;margin-top:5px;padding-left:0px;padding-right:0px;">

		    <div class="col-8" style="padding-left:0px;padding-top:10px;">
			<div style="border:1px solid black;width=100%;padding-left:2px;">
				<span><strong>OBSERVACIONES: </strong></span>
					<span t-field="o.narration"/>
			</div>
			<br/>
			<span>DOCUMENTO(S) DE REFERENCIA</span>
			<div name="references" style="border:1px solid black;width=100%">
                            <table name="invoice_references">
                                <tr>
                                    <td style="width:30%" class="text-center"><span>Tipo Doc</span></td>
                                    <td style="width:20%" class="text-center text-nowrap"><span>Fecha Emisión</span></td>
                                    <td style="width:20%" class="text-center"><span>Folio</span></td>
                                    <td style="width:30%" class="text-center"><span>Razón de Referencia</span></td>
                                </tr>
                                <t t-if="o.l10n_cl_reference_ids">
                                <t t-foreach="o.l10n_cl_reference_ids" t-as="refs">
                                <tr>
                                    <td class="text-left"><span t-field="refs.l10n_cl_reference_doc_type_selection"/></td>
                                    <td class="text-left"><span t-field="refs.date"/></td>
                                    <td class="text-left"><span t-field="refs.origin_doc_number"/></td>
                                    <td class="text-left"><span t-field="refs.reason"/></td>
                                </tr>
                                </t>
                                </t>
                            </table>
			</div>
                    </div>

		    <!-- Timbre -->
		    <div class="col-4 text-center" style="margin-right:0px;padding-right:0px;">
		        <div class="row" style="border:1px solid black;width=100%;padding-left:2px;padding-right:2px;">
			    <table style="width:100%">
			        <t t-call="formato_l10n_cl.document_tax_totals"/>
			    </table>
			</div>
			<t t-if="o.l10n_cl_sii_barcode">
			    <div name="stamp" class="row text-center">
                                <t t-set="barcode_stamp" t-value="o._pdf417_barcode(o.l10n_cl_sii_barcode)"/>
                                <t t-if="barcode_stamp">
                                    <img class="img-fluid" t-attf-src="data:image/*;base64,{{barcode_stamp}}"/>
                                </t>
			    </div>
			    <div class="row text-center">
                                <p t-att-style="'color: %s;' % o.company_id.primary_color" class="text-center small">
                                    Timbre Electrónico SII<br/>
                                    Res. Nº: <span t-field="o.company_id.l10n_cl_dte_resolution_number"/>
                                    del : <span t-field="o.company_id.l10n_cl_dte_resolution_date" t-field-options='{"widget": "date"}'/>
                                    <span name="verification_url"> Verifique documento: www.sii.cl</span>
                                </p>
			    </div>
                        </t>
                    </div>


                </div>

			<t t-out="0"/>

	    </t> <!-- basic_layout -->
        </template>

    </data>
</odoo>
